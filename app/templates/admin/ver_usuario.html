{% extends "base.html" %}

{% block title %}Detalles de Usuario{% endblock %}

{% block head %}
<style>
/* Estilos para la imagen de perfil circular - igual que en dashboard */
.rounded-circle {
    cursor: pointer;
    transition: all 0.3s ease;
}

.rounded-circle:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

/* Efectos para el modal de imagen */
#imageModal .modal-dialog {
    max-width: 90%;
}

#imageModal .modal-body img {
    max-height: 80vh;
    object-fit: contain;
}

/* Responsive para móviles */
@media (max-width: 768px) {
    .rounded-circle {
        width: 120px !important;
        height: 120px !important;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">
                    <i class="fas fa-user me-2"></i>
                </h1>
                <div>
                    <a href="{{ url_for('admin.editar_usuario', usuario_id=usuario.Id) }}" class="btn btn-warning me-2">
                        <i class="fas fa-edit me-1"></i>Editar
                    </a>
                    <a href="{{ url_for('admin.usuarios') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-1"></i>Volver
                    </a>
                </div>
            </div>

            <div class="row">
                <!-- Información del Usuario -->
                <div class="col-md-4 mb-4">
                    <div class="card shadow-sm">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-user-circle me-2"></i>Información Personal
                            </h5>
                        </div>
                        <div class="card-body text-center">

                            <!-- ✅ FOTO DE PERFIL -->
                            <div class="text-center mb-3">
                                {% if usuario.FotoPerfil %}
                                    <img src="{{ url_for('static', filename=usuario.FotoPerfil) }}"
                                         alt="Foto de perfil"
                                         class="rounded-circle mb-3" 
                                         width="150" 
                                         height="150" 
                                         style="object-fit: cover;"
                                         onclick="openImageModal('{{ url_for('static', filename=usuario.FotoPerfil) }}', '{{ usuario.Nombre }}')">
                                {% else %}
                                    <img src="{{ url_for('static', filename='images/default-user.png') }}"
                                         alt="Sin foto"
                                         class="rounded-circle mb-3" 
                                         width="150" 
                                         height="150" 
                                         style="object-fit: cover;"
                                         onclick="openImageModal('{{ url_for('static', filename='images/default-user.png') }}', '{{ usuario.Nombre }}')">
                                {% endif %}
                            </div>

                            <h4>{{ usuario.Nombre }}</h4>
                            <span class="badge bg-{{ 'primary' if usuario.rol.Nombre == 'admin' else 'success' if usuario.rol.Nombre == 'empleado' else 'info' }} fs-6">
                                {{ usuario.rol.Nombre|title }}
                            </span>

                            <hr>

                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-envelope text-muted me-2"></i>
                                <div>
                                    <small class="text-muted">Email</small>
                                    <div>
                                        <a href="mailto:{{ usuario.Email }}" class="text-decoration-none">
                                            {{ usuario.Email }}
                                        </a>
                                    </div>
                                </div>
                            </div>

                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-phone text-muted me-2"></i>
                                <div>
                                    <small class="text-muted">Teléfono</small>
                                    <div>
                                        {% if usuario.Telefono %}
                                            <a href="tel:{{ usuario.Telefono }}" class="text-decoration-none">
                                                {{ usuario.Telefono }}
                                            </a>
                                        {% else %}
                                            <span class="text-muted">No especificado</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-calendar text-muted me-2"></i>
                                <div>
                                    <small class="text-muted">Fecha de Registro</small>
                                    <div>
                                        {% if usuario.FechaRegistro %}
                                            {{ usuario.FechaRegistro.strftime('%d/%m/%Y %H:%M') }}
                                        {% else %}
                                            <span class="text-muted">No disponible</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <div class="d-flex align-items-center">
                                <i class="fas fa-clock text-muted me-2"></i>
                                <div>
                                    <small class="text-muted">Estado</small>
                                    <div>
                                        <span class="badge bg-{{ 'success' if usuario.Estado else 'danger' }}">
                                            {{ 'Activo' if usuario.Estado else 'Inactivo' }}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Estadísticas y Reservas -->
                <div class="col-md-8">
                    <!-- Estadísticas -->
                    <div class="row mb-4">
                        <div class="col-md-4 mb-3">
                            <div class="card bg-primary text-white">
                                <div class="card-body text-center">
                                    <i class="fas fa-calendar-check fa-2x mb-2"></i>
                                    <h4>{{ reservas|length }}</h4>
                                    <p class="mb-0">Total Reservas</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="card bg-success text-white">
                                <div class="card-body text-center">
                                    <i class="fas fa-check-circle fa-2x mb-2"></i>
                                    <h4>{{ reservas|selectattr('Estado', 'equalto', 'Confirmada')|list|length }}</h4>
                                    <p class="mb-0">Confirmadas</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="card bg-warning text-dark">
                                <div class="card-body text-center">
                                    <i class="fas fa-clock fa-2x mb-2"></i>
                                    <h4>{{ reservas|selectattr('Estado', 'equalto', 'Pendiente')|list|length }}</h4>
                                    <p class="mb-0">Pendientes</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Lista de Reservas -->
                    <div class="card shadow-sm">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-list me-2"></i>Historial de Reservas
                                {% if reservas|length > 5 %}
                                <span class="badge bg-info ms-2">{{ reservas|length }} reservas totales</span>
                                {% endif %}
                            </h5>
                        </div>
                        <div class="card-body p-0">
                            {% if reservas %}
                                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                    <table class="table table-hover mb-0">
                                        <thead class="table-dark sticky-top">
                                            <tr>
                                                <th>ID</th>
                                                <th>Cancha</th>
                                                <th>Fecha</th>
                                                <th>Hora</th>
                                                <th>Duración</th>
                                                <th>Precio</th>
                                                <th>Estado</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for reserva in reservas[:5] %}
                                            <tr>
                                                <td>{{ reserva.Id }}</td>
                                                <td>
                                                    <strong>{{ reserva.cancha.Nombre }}</strong><br>
                                                    <small class="text-muted">{{ reserva.cancha.tipo_cancha_rel.Nombre }}</small>
                                                </td>
                                                <td>{{ reserva.Fecha.strftime('%d/%m/%Y') }}</td>
                                                <td>{{ reserva.HoraInicio.strftime('%H:%M') }}</td>
                                                <td>{{ reserva.duracion_horas }} hora(s)</td>
                                                <td>{{ format_currency(reserva.precio_total) }}</td>
                                                <td>
                                                    <span class="badge bg-{{ 'success' if reserva.Estado == 'Confirmada' else 'warning' if reserva.Estado == 'Pendiente' else 'danger' }}">
                                                        {{ reserva.Estado }}
                                                    </span>
                                                </td>
                                                <td>
                                                    <div class="btn-group" role="group">
                                                        <a href="{{ url_for('admin.ver_reserva', reserva_id=reserva.Id) }}" 
                                                           class="btn btn-sm btn-outline-info" 
                                                           title="Ver detalles">
                                                            <i class="fas fa-eye"></i>
                                                        </a>
                                                        {% if reserva.Estado != 'Cancelada' %}
                                                        <button type="button" 
                                                                class="btn btn-sm btn-outline-danger" 
                                                                title="Cancelar reserva"
                                                                onclick="confirmarCancelacion({{ reserva.Id }})">
                                                            <i class="fas fa-times"></i>
                                                        </button>
                                                        {% endif %}
                                                    </div>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                            
                                            {% if reservas|length > 5 %}
                                            <!-- Reservas adicionales (ocultas por defecto) -->
                                            {% for reserva in reservas[5:] %}
                                            <tr class="reserva-oculta" style="display: none;">
                                                <td>{{ reserva.Id }}</td>
                                                <td>
                                                    <strong>{{ reserva.cancha.Nombre }}</strong><br>
                                                    <small class="text-muted">{{ reserva.cancha.tipo_cancha_rel.Nombre }}</small>
                                                </td>
                                                <td>{{ reserva.Fecha.strftime('%d/%m/%Y') }}</td>
                                                <td>{{ reserva.HoraInicio.strftime('%H:%M') }}</td>
                                                <td>{{ reserva.duracion_horas }} hora(s)</td>
                                                <td>{{ format_currency(reserva.precio_total) }}</td>
                                                <td>
                                                    <span class="badge bg-{{ 'success' if reserva.Estado == 'Confirmada' else 'warning' if reserva.Estado == 'Pendiente' else 'danger' }}">
                                                        {{ reserva.Estado }}
                                                    </span>
                                                </td>
                                                <td>
                                                    <div class="btn-group" role="group">
                                                        <a href="{{ url_for('admin.ver_reserva', reserva_id=reserva.Id) }}" 
                                                           class="btn btn-sm btn-outline-info" 
                                                           title="Ver detalles">
                                                            <i class="fas fa-eye"></i>
                                                        </a>
                                                        {% if reserva.Estado != 'Cancelada' %}
                                                        <button type="button" 
                                                                class="btn btn-sm btn-outline-danger" 
                                                                title="Cancelar reserva"
                                                                onclick="confirmarCancelacion({{ reserva.Id }})">
                                                            <i class="fas fa-times"></i>
                                                        </button>
                                                        {% endif %}
                                                    </div>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                            {% endif %}
                                        </tbody>
                                    </table>
                                </div>
                                
                                {% if reservas|length > 5 %}
                                <div class="card-footer text-center">
                                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="toggleReservasOcultas()">
                                        <i class="fas fa-chevron-down me-1"></i>
                                        <span id="toggle-text">Ver más reservas ({{ reservas|length - 5 }} restantes)</span>
                                    </button>
                                </div>
                                {% endif %}
                            {% else %}
                                <div class="text-center py-4">
                                    <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                                    <p class="text-muted">Este usuario no tiene reservas registradas</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirmación para cancelar reserva -->
<div class="modal fade" id="modalCancelar" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmar cancelación</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>¿Estás seguro de que quieres cancelar esta reserva?</p>
                <p class="text-danger"><small>Esta acción no se puede deshacer.</small></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <form id="formCancelar" method="POST" style="display: inline;">
                    <button type="submit" class="btn btn-danger">Confirmar Cancelación</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal para mostrar imagen ampliada -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageModalLabel">Foto de Perfil</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <img id="modalImage" src="" alt="Imagen ampliada" class="img-fluid">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
/* Estilos para la tabla con scroll */
.table-responsive {
    border-radius: 0.375rem;
}

.table-responsive::-webkit-scrollbar {
    width: 8px;
}

.table-responsive::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
}

.table-responsive::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 4px;
}

.table-responsive::-webkit-scrollbar-thumb:hover {
    background: #555;
}

/* Estilos para el header sticky */
.sticky-top {
    position: sticky;
    top: 0;
    z-index: 1020;
    background-color: #343a40;
}

/* Estilos para el botón toggle */
.btn-outline-primary:hover {
    transform: translateY(-1px);
    transition: transform 0.2s ease;
}

/* Animación para mostrar/ocultar reservas */
.reserva-oculta {
    transition: opacity 0.3s ease;
}

/* Estilos para el badge de total de reservas */
.badge.bg-info {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
}
</style>
{% endblock %}

{% block scripts %}
<script>
function confirmarCancelacion(reservaId) {
    document.getElementById('formCancelar').action = `/admin/reserva/cancelar/${reservaId}`;
    new bootstrap.Modal(document.getElementById('modalCancelar')).show();
}

// Función para abrir el modal de imagen
function openImageModal(imageSrc, userName) {
    const modal = document.getElementById('imageModal');
    const modalImage = document.getElementById('modalImage');
    const modalTitle = document.getElementById('imageModalLabel');
    
    // Configurar la imagen y el título
    modalImage.src = imageSrc;
    modalTitle.textContent = `Foto de Perfil - ${userName}`;
    
    // Mostrar el modal
    const bootstrapModal = new bootstrap.Modal(modal);
    bootstrapModal.show();
}

// Agregar indicador visual de que la imagen es clickeable
document.addEventListener('DOMContentLoaded', function() {
    const profileImage = document.querySelector('.profile-image-circle');
    if (profileImage) {
        // Agregar tooltip o indicador visual
        profileImage.title = 'Haz clic para ver en grande';
    }
});

// Función para mostrar/ocultar reservas adicionales
function toggleReservasOcultas() {
    const reservasOcultas = document.querySelectorAll('.reserva-oculta');
    const toggleButton = document.querySelector('[onclick="toggleReservasOcultas()"]');
    const toggleText = document.getElementById('toggle-text');
    const toggleIcon = toggleButton.querySelector('i');
    
    let todasVisibles = true;
    reservasOcultas.forEach(reserva => {
        if (reserva.style.display === 'none') {
            todasVisibles = false;
        }
    });
    
    if (todasVisibles) {
        // Ocultar reservas adicionales
        reservasOcultas.forEach(reserva => {
            reserva.style.display = 'none';
        });
        toggleIcon.className = 'fas fa-chevron-down me-1';
        toggleText.textContent = `Ver más reservas (${reservasOcultas.length} restantes)`;
    } else {
        // Mostrar reservas adicionales
        reservasOcultas.forEach(reserva => {
            reserva.style.display = 'table-row';
        });
        toggleIcon.className = 'fas fa-chevron-up me-1';
        toggleText.textContent = 'Ocultar reservas adicionales';
    }
}
</script>
{% endblock %}
